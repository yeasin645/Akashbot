const express = require('express');
const TelegramBot = require('node-telegram-bot-api');
const mongoose = require('mongoose');
const moment = require('moment-timezone');
const axios = require('axios');
const cron = require('node-cron');

const app = express();
app.use(express.json());

// --- Configuration ---
const config = {
    token: process.env.BOT_TOKEN, 
    mongoUri: process.env.MONGODB_URI,
    adminId: parseInt(process.env.ADMIN_ID), 
    appUrl: process.env.APP_URL, 
    adminUsername: process.env.ADMIN_USERNAME || "Admin",
    dbVersion: process.env.DB_VERSION || "1.0"
};

// 409 Conflict Error ‡¶è‡ßú‡¶æ‡¶§‡ßá ‡¶™‡ßã‡¶≤‡¶ø‡¶Ç ‡¶è‡¶∞ ‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶™‡ßç‡¶Ø‡¶æ‡¶∞‡¶æ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá
const bot = new TelegramBot(config.token, { 
    polling: {
        autoStart: true,
        params: { timeout: 10 }
    }
});

// ‡¶è‡¶∞‡¶∞ ‡¶π‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶≤‡¶æ‡¶∞ (‡¶™‡ßã‡¶≤‡¶ø‡¶Ç ‡¶è‡¶∞‡¶∞ ‡¶Ü‡¶∏‡¶≤‡ßá ‡¶¨‡¶ü ‡¶¨‡¶®‡ßç‡¶ß ‡¶π‡¶¨‡ßá ‡¶®‡¶æ)
bot.on('polling_error', (error) => {
    if (error.code === 'ETELEGRAM' && error.message.includes('409 Conflict')) {
        console.log("‚ö†Ô∏è Conflict detected. Retrying in 5 seconds...");
    } else {
        console.error("‚ùå Polling Error:", error.message);
    }
});

// --- MongoDB ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡¶∂‡¶® ‡¶ì ‡¶Ö‡¶ü‡ßã-‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ---
mongoose.connect(config.mongoUri).then(async () => {
    console.log("‚úÖ Database Connected!");
    const VersionModel = mongoose.model('DBVersion', new mongoose.Schema({ version: String }));
    const currentVer = await VersionModel.findOne();
    if (!currentVer) {
        await new VersionModel({ version: config.dbVersion }).save();
    } else if (currentVer.version !== config.dbVersion) {
        const collections = await mongoose.connection.db.collections();
        for (let col of collections) await col.deleteMany({});
        await VersionModel.updateOne({}, { version: config.dbVersion });
        console.log("‚ôªÔ∏è Database Reset Done.");
    }
});

// --- ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶∏ ‡¶Æ‡¶°‡ßá‡¶≤‡¶∏‡¶Æ‡ßÇ‡¶π ---
const User = mongoose.model('User', new mongoose.Schema({ userId: Number, joinedAt: { type: Date, default: Date.now } }));
const PremiumUser = mongoose.model('PremiumUser', new mongoose.Schema({ userId: Number, packageName: String, expiryDate: Date }));
const UserProfile = mongoose.model('UserProfile', new mongoose.Schema({ userId: Number, savedChannels: { type: Array, default: [] }, userZoneId: { type: String, default: null } }));
const Post = mongoose.model('Post', new mongoose.Schema({ id: String, creatorId: Number, title: String, image: String, language: String, links: Array, channels: Array, zoneId: String }));

let userState = {};

// --- ‡¶π‡ßá‡¶≤‡ßç‡¶™‡¶æ‡¶∞‡¶∏ ---
async function isPremium(chatId) {
    if (chatId === config.adminId) return true;
    const user = await PremiumUser.findOne({ userId: chatId });
    if (!user) return false;
    if (new Date() > user.expiryDate) {
        await PremiumUser.deleteOne({ userId: chatId });
        return false;
    }
    return true;
}

function generateHTML(post, zoneId, clicks = 3) {
    let qBtns = post.links.map(i => `<button class="btn" onclick="startAd('${i.link}')">${i.quality} - ‡¶Ü‡¶®‡¶≤‡¶ï</button>`).join('');
    let chSection = (post.channels && post.channels.length > 0) ? 
        `<div class="ch-box"><h3>üì¢ ‡¶ú‡ßü‡ßá‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®:</h3>${post.channels.map(ch => `<a href="${ch.link}" target="_blank" class="ch-link">${ch.name}</a>`).join('')}</div>` : "";

    return `<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src='//libtl.com/sdk.js' data-zone='${zoneId}' data-sdk='show_${zoneId}'></script>
    <style>body{font-family:sans-serif;background:#0f172a;color:white;text-align:center;padding:20px;}
    .card{background:#1e293b;padding:20px;border-radius:15px;max-width:400px;margin:auto;}img{width:100%;border-radius:10px;margin-bottom:15px;}
    .ch-box{background:rgba(59,130,246,0.1);padding:10px;margin-bottom:15px;border-radius:10px;}
    .ch-link{display:inline-block;background:#3b82f6;color:white;text-decoration:none;padding:8px 15px;margin:4px;border-radius:6px;font-weight:bold;}
    .btn{background:#2563eb;color:white;padding:14px;width:100%;border-radius:10px;margin:10px 0;border:none;font-weight:bold;cursor:pointer;}</style></head>
    <body><div class="card"><img src="${post.image}"><h2>${post.title}</h2>${chSection}<div id="st">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶¶‡ßá‡¶ñ‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá: 0/${clicks}</div>${qBtns}</div>
    <script>let c=0;function startAd(u){if(c<${clicks}){if(typeof window['show_'+'${zoneId}'] === 'function'){window['show_'+'${zoneId}']().then(()=>{c++;document.getElementById('st').innerText="‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶¶‡ßá‡¶ñ‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá: "+c+"/${clicks}";});}else{c++;}}else{location.href=u;}}</script></body></html>`;
}

// --- ‡¶Æ‡ßá‡¶á‡¶® ‡¶Æ‡ßá‡¶®‡ßÅ ---
async function showMainMenu(chatId) {
    let buttons = [
        [{ text: "üé¨ ‡¶Æ‡ßÅ‡¶≠‡¶ø ‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶§‡ßà‡¶∞‡¶ø", callback_data: "start_post" }],
        [{ text: "üì¢ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶∏‡ßá‡¶ü‡¶Ü‡¶™", callback_data: "setup_channels" }, { text: "üÜî ‡¶ú‡ßã‡¶® ‡¶Ü‡¶á‡¶°‡¶ø ‡¶∏‡ßá‡¶ü", callback_data: "set_zone" }],
        [{ text: "üíé ‡¶™‡ßç‡¶∞‡¶ø‡¶Æ‡¶ø‡ßü‡¶æ‡¶Æ ‡¶™‡ßç‡¶≤‡ßç‡¶Ø‡¶æ‡¶®", callback_data: "view_premium" }]
    ];
    if (chatId === config.adminId) {
        buttons.push([{ text: "üìä ‡¶™‡¶∞‡¶ø‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ‡¶®", callback_data: "view_stats" }, { text: "‚ûï ‡¶Æ‡ßá‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°", callback_data: "adm_add_prompt" }]);
    }
    bot.sendMessage(chatId, "üõ† **‡¶¨‡¶ü ‡¶Æ‡ßá‡¶á‡¶® ‡¶Æ‡ßá‡¶®‡ßÅ**", { parse_mode: 'Markdown', reply_markup: { inline_keyboard: buttons } });
}

bot.onText(/\/start/, async (msg) => {
    await User.findOneAndUpdate({ userId: msg.chat.id }, { userId: msg.chat.id }, { upsert: true });
    showMainMenu(msg.chat.id);
});

// --- ‡¶¨‡¶æ‡¶ü‡¶® ‡¶≤‡¶ú‡¶ø‡¶ï (‡¶¨‡¶æ‡¶ü‡¶® ‡¶´‡¶ø‡¶ï‡ßç‡¶∏ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá) ---
bot.on('callback_query', async (q) => {
    const chatId = q.message.chat.id;
    const data = q.data;
    const isPrem = await isPremium(chatId);

    if (["start_post", "setup_channels", "set_zone"].includes(data) && !isPrem) {
        return bot.answerCallbackQuery(q.id, { text: "‚ùå ‡¶Ü‡¶ó‡ßá ‡¶™‡ßç‡¶∞‡¶ø‡¶Æ‡¶ø‡ßü‡¶æ‡¶Æ ‡¶Æ‡ßá‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞‡¶∂‡¶ø‡¶™ ‡¶®‡¶ø‡¶®!", show_alert: true });
    }

    if (data === "start_post") {
        userState[chatId] = { step: 'title', links: [] };
        bot.sendMessage(chatId, "üé¨ ‡¶Æ‡ßÅ‡¶≠‡¶ø‡¶∞ ‡¶®‡¶æ‡¶Æ (Title) ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®:");
    }
    else if (data === "setup_channels") {
        const profile = await UserProfile.findOne({ userId: chatId });
        let txt = "üì¢ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡¶∏‡¶Æ‡ßÇ‡¶π:\n";
        if (!profile || !profile.savedChannels.length) txt += "‡¶®‡ßá‡¶á‡•§";
        else profile.savedChannels.forEach((c, i) => txt += `${i+1}. ${c.name}\n`);
        bot.sendMessage(chatId, txt, { reply_markup: { inline_keyboard: [[{ text: "‚ûï ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®", callback_data: "add_ch" }], [{ text: "üóë ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®", callback_data: "clear_ch" }]] } });
    }
    else if (data === "clear_ch") {
        await UserProfile.findOneAndUpdate({ userId: chatId }, { savedChannels: [] });
        bot.sendMessage(chatId, "‚úÖ ‡¶∏‡¶¨ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§");
    }
    else if (data === "add_ch") { userState[chatId] = { step: 'ch_name' }; bot.sendMessage(chatId, "‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ:"); }
    else if (data === "set_zone") { userState[chatId] = { step: 'u_zone' }; bot.sendMessage(chatId, "Adsterra Zone ID ‡¶¶‡¶ø‡¶®:"); }
    else if (data === "adm_add_prompt" && chatId === config.adminId) {
        userState[chatId] = { step: 'add_user' };
        bot.sendMessage(chatId, "üë§ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®: `ID | Days | Plan`", { parse_mode: 'Markdown' });
    }
    else if (data === "view_stats" && chatId === config.adminId) {
        const u = await User.countDocuments();
        const p = await PremiumUser.countDocuments();
        bot.sendMessage(chatId, `üìä ‡¶á‡¶â‡¶ú‡¶æ‡¶∞: ${u}\nüíé ‡¶™‡ßç‡¶∞‡¶ø‡¶Æ‡¶ø‡ßü‡¶æ‡¶Æ: ${p}`);
    }
    else if (data === "skip_q") {
        bot.sendMessage(chatId, "‡¶∏‡¶¨ ‡¶†‡¶ø‡¶ï ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®:", { reply_markup: { inline_keyboard: [[{ text: "üöÄ ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü HTML", callback_data: "confirm" }]] } });
    }
    else if (data === "confirm" && userState[chatId]) {
        const s = userState[chatId];
        const profile = await UserProfile.findOne({ userId: chatId });
        const finalZone = (profile && profile.userZoneId) ? profile.userZoneId : '10341337';
        const id = Math.random().toString(36).substring(7);
        await new Post({ id, creatorId: chatId, title: s.title, image: s.image, language: s.language, links: s.links, channels: profile ? profile.savedChannels : [], zoneId: finalZone }).save();
        bot.sendMessage(chatId, `‚úÖ ‡¶∏‡¶´‡¶≤!\nüîó ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï: ${config.appUrl}/post/${id}\n\n‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ï‡ßã‡¶° ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§`, { parse_mode: 'Markdown' });
        delete userState[chatId];
    }
    bot.answerCallbackQuery(q.id);
});

// --- ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶π‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶≤‡¶ø‡¶Ç ---
bot.on('message', async (msg) => {
    const chatId = msg.chat.id;
    const text = msg.text;
    if (!text || text.startsWith('/')) return;

    if (userState[chatId]) {
        let s = userState[chatId];
        if (s.step === 'add_user' && chatId === config.adminId) {
            const p = text.split('|'); if (p.length < 3) return;
            const expiry = moment().add(parseInt(p[1].trim()), 'days').toDate();
            await PremiumUser.findOneAndUpdate({ userId: parseInt(p[0].trim()) }, { packageName: p[2].trim(), expiryDate: expiry }, { upsert: true });
            bot.sendMessage(chatId, "‚úÖ ‡¶™‡ßç‡¶∞‡¶ø‡¶Æ‡¶ø‡ßü‡¶æ‡¶Æ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§"); delete userState[chatId];
        }
        else if (s.step === 'u_zone') { await UserProfile.findOneAndUpdate({ userId: chatId }, { userZoneId: text.trim() }, { upsert: true }); bot.sendMessage(chatId, "‚úÖ ‡¶ú‡ßã‡¶® ‡¶Ü‡¶á‡¶°‡¶ø ‡¶∏‡ßá‡¶ü‡•§"); delete userState[chatId]; }
        else if (s.step === 'ch_name') { s.tempN = text; s.step = 'ch_link'; bot.sendMessage(chatId, "‡¶≤‡¶ø‡¶ô‡ßç‡¶ï ‡¶¶‡¶ø‡¶®:"); }
        else if (s.step === 'ch_link') { await UserProfile.findOneAndUpdate({ userId: chatId }, { $push: { savedChannels: { name: s.tempN, link: text } } }, { upsert: true }); bot.sendMessage(chatId, "‚úÖ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§"); delete userState[chatId]; }
        else if (s.step === 'title') { s.title = text; s.step = 'image'; bot.sendMessage(chatId, "üñº ‡¶á‡¶Æ‡ßá‡¶ú ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï:"); }
        else if (s.step === 'image') { s.image = text; s.step = 'lang'; bot.sendMessage(chatId, "‡¶≠‡¶æ‡¶∑‡¶æ?"); }
        else if (s.step === 'lang') { s.language = text; s.step = 'q_name'; bot.sendMessage(chatId, "‡¶ï‡ßã‡ßü‡¶æ‡¶≤‡¶ø‡¶ü‡¶ø (‡¶â‡¶¶‡¶æ: 720p):"); }
        else if (s.step === 'q_name') { s.tempQ = text; s.step = 'q_link'; bot.sendMessage(chatId, "‡¶Æ‡ßÅ‡¶≠‡¶ø ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï:"); }
        else if (s.step === 'q_link') {
            s.links.push({ quality: s.tempQ, link: text }); s.step = 'q_name';
            bot.sendMessage(chatId, "‡¶Ü‡¶∞‡¶ì ‡¶ï‡ßã‡ßü‡¶æ‡¶≤‡¶ø‡¶ü‡¶ø ‡¶Ö‡¶•‡¶¨‡¶æ Skip ‡¶¶‡¶ø‡¶®‡•§", { reply_markup: { inline_keyboard: [[{ text: "‚è© Skip", callback_data: "skip_q" }]] } });
        }
    }
});

// --- ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶∞‡ßÅ‡¶ü‡¶∏ ---
app.get('/post/:id', async (req, res) => {
    const post = await Post.findOne({ id: req.params.id });
    if (!post) return res.send("Not Found");
    res.send(generateHTML(post, post.zoneId));
});
app.get('/', (req, res) => res.send("Bot Online"));

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
    console.log(`Server started on ${PORT}`);
    if (config.appUrl) {
        cron.schedule('*/5 * * * *', () => axios.get(config.appUrl).catch(e => {}));
    }
});
